# vim: filetype=bash
_env_cmd chezmoi || return

if ! chezmoi source-path >/dev/null 2>&1; then
    alias czup="chezmoi init --force --purge --apply freepaddler"
    alias cz-init="chezmoi init --apply freepaddler"
    return
fi

# chezmoi state
if [ -z "$TMUX" ]; then
    _verify=$(chezmoi verify --exclude=scripts >/dev/null 2>&1 || echo "drift (inspect with 'cz-state') ")
    _uncommitted=$(chezmoi git status -- --porcelain 2>/dev/null | grep -q . && echo "uncommitted " || :)
    _unpushed=$(chezmoi git log -- --branches --not --remotes --oneline 2>/dev/null | grep -q . && echo "unpushed" || :)

    [ -n "${_verify}${_uncommitted}${_unpushed}" ] && \
      printf "\033[33mchezmoi: %s%s%s\033[0m\n" "$_verify" "$_uncommitted" "$_unpushed"
    unset _verify _uncommitted _unpushed
fi

alias cz="chezmoi "
alias czup="chezmoi update && resrc"
alias czap="chezmoi apply && resrc"
alias cz-state="chezmoi status --exclude=scripts"

# these work only with git binary
_env_cmd git && {
    alias cz-state="chezmoi status --exclude=scripts; cz git -- status -s"
    alias cz-edit="chezmoi edit --apply"
    alias sshconfig="cz-edit ~/.ssh/config && resrc"
    alias cz-diff="chezmoi diff --exclude=scripts"

    cz-add() {
        if [ "$#" -lt 1 ]; then
            echo "usage: cz-add <files>"
            return 1
        fi
        for f in "$@"; do
            if chezmoi source-path "$f" > /dev/null 2>&1; then
                chezmoi re-add --interactive "$f"
            else
                echo "add file $f"
                chezmoi add "$f"
            fi
        done
    }


    # chezmoi save all changes
    cz-save() {
        echo "Saving chezmoi changes to git..."
        echo

        chezmoi git -- diff --quiet 2>/dev/null || \
            chezmoi git add .

        chezmoi git -- diff --cached --quiet 2>/dev/null || {
            echo "Changes:"
            chezmoi git -- status -s
            sleep 2.5
            echo
            chezmoi git -- commit -m "${*:-$(chezmoi git -- status -s)}" -m "$(hostname -s)"
        }

        chezmoi git -- pull --rebase && chezmoi git push

        echo
        echo "Chezmoi saved to git"
    }
}

# remote local install chezmoi
cz-ssh() {
    ssh "$@" 'sh <(curl -fsLS get.chezmoi.io/lb || wget -qO- get.chezmoi.io/lb) -- init --force --purge --apply freepaddler'
}

_env_shell zsh && compdef _ssh cz-ssh=ssh

_env_shell bash && {
    . <(chezmoi completion bash --)
    _env_bash_clone_completion ssh cz-ssh
}
