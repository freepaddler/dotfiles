### AUTOCOMPLETION

# try load completions
completion_script_locations="
    /etc/profile.d
    ${HOMEBREW_PREFIX:+$HOMEBREW_PREFIX/etc/profile.d}
    /usr/local/share/bash-completion
    /opt/local/etc/profile.d

"
for bcsh in $completion_script_locations; do
        [ -n "$BASH_COMPLETION_VERSINFO" ] && break
        [ -f "$bcsh/bash_completion.sh" ] && source "$bcsh/bash_completion.sh"
done
unset bsch
unset completion_script_locations

# load personal completions
if [ -n "$BASH_COMPLETION_VERSINFO" ]; then
    for f in "$HOME"/.bash_completion.d/* "$DOTFILES"/bash/completions/; do
        # shellcheck disable=SC1090
        [ -f "$f" ] && source "$f"
    done
    unset f
fi

# check if command has completion
_dotfiles_unset_add _dotfiles_has_bash_completion
_dotfiles_has_bash_completion() {
    [ -n "$BASH_VERSION" ] || return 0
    # completion exists
    complete -p "$1" &> /dev/null && return 0
    # no loader -> no completion
    [ "$(type -t _completion_loader)" = "function" ] || return 1
    # try load completion
    _completion_loader "$1"
    # _minimal default to no completion
    [[ $(complete -p "$1" 2> /dev/null) = *_minimal* ]] || return 0
    # delete _minimal completion -> no completion
    complete -r "$1"
    return 1
}

# clone current completion
_dotfiles_unset_add _dotfiles_clone_bash_completion
_dotfiles_clone_bash_completion() {
    [ -n "$BASH_VERSION" ] || return 0
    if _dotfiles_has_bash_completion $1; then
        complete -r $2 &>/dev/null
        $(complete -p $1) "$2"
    fi
}

# if no bash-completion, let's make out life a little bit easier
_dotfiles_has_bash_completion man || complete -cf man
_dotfiles_has_bash_completion nohup || complete -c -o bashdefault -o default nohup
_dotfiles_has_bash_completion su || complete -c -o bashdefault -o default su